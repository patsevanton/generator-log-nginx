# Nginx Log Generator

Этот проект является форком https://github.com/kscarlett/nginx-log-generator с изменённой логикой генерации логов.

Утилита на Go для генерации реалистичных логов Nginx в формате JSON. Она предназначена для тестирования пайплайнов сбора логов, демонстрации работы в Kubernetes и других сценариев, требующих реалистичных данных логов.

Большая часть данных генерируется с помощью библиотеки [gofakeit](https://github.com/brianvoe/gofakeit).

## Основные изменения в форке

В отличие от исходной версии, в этой реализации **все основные параметры логов задаются через обязательные переменные окружения**, что обеспечивает полный контроль над генерируемыми данными:

- **IP_ADDRESSES** - список IP-адресов
- **HTTP_METHODS** - список HTTP-методов
- **PATHS** - список URL-путей
- **STATUS_CODES** - список HTTP-статус кодов
- **HOSTS** - список доменных имен

## Сборка из исходного кода

Для сборки бинарного файла из исходного кода:

1. Убедитесь, что у вас установлен Go (версия 1.25 или выше)
2. Выполните сборку:
```shell
go build -o nginx-log-generator .
```

## Использование

### Основные обязательные переменные окружения

```shell
# Минимальный пример запуска
IP_ADDRESSES="10.0.0.1,10.0.0.2,10.0.0.3" \
HTTP_METHODS="GET,POST,PUT" \
PATHS="/api/v1/users,/api/v1/products,/api/v1/categories" \
STATUS_CODES="200,400,404,500,503" \
HOSTS="api.example.com" \
RATE=5 \
./nginx-log-generator
```

### Запуск через Docker

```shell
docker pull ghcr.io/patsevanton/generator-log-nginx:latest

docker run \
  -e "IP_ADDRESSES=10.0.0.1,10.0.0.2,10.0.0.3" \
  -e "HTTP_METHODS=GET,POST,PUT" \
  -e "PATHS=/api/v1/users,/api/v1/products,/api/v1/categories" \
  -e "STATUS_CODES=200,400,404,500,503" \
  -e "HOSTS=api.example.com" \
  -e "RATE=10" \
  ghcr.io/patsevanton/generator-log-nginx:latest
```

### Конфигурация

Все переменные окружения, кроме отмеченных, являются обязательными:

| Название              | Обязательный | По умолчанию | Описание                                                                 |
| --------------------- | ------------ | ------------ | ------------------------------------------------------------------------ |
| **IP_ADDRESSES**      | **Да**       | -            | Список IP-адресов через запятую (например, "192.168.1.1,10.0.0.1")       |
| **HTTP_METHODS**      | **Да**       | -            | Список HTTP-методов через запятую (например, "GET,POST,PUT")             |
| **PATHS**             | **Да**       | -            | Список путей через запятую (например, "/api/v1/users,/api/v1/products")  |
| **STATUS_CODES**      | **Да**       | -            | Список кодов статуса через запятую (например, "200,400,404,500")         |
| **HOSTS**             | **Да**       | -            | Список хостов через запятую (например, "example.com,api.example.com")    |
| RATE                  | Нет          | 1            | Количество логов в секунду (float)                                       |

**Важно**: 
- Если списки (`IP_ADDRESSES`, `HTTP_METHODS`, `PATHS`, `STATUS_CODES`, `HOSTS`) не заданы, программа завершится с ошибкой
- Значения выбираются случайным образом из предоставленных списков

## Пример выходных данных

Программа выводит логи в формате JSON с префиксом:
```
ingress-nginx-controller controller {"ts":"2023-10-01T12:00:00Z","http":{...},"nginx":{...}}
```

Пример полной записи лога:
```json
{
  "ts": "2023-10-01T12:00:00Z",
  "http": {
    "request_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "method": "GET",
    "status_code": 200,
    "url": "api.example.com/api/v1/users",
    "host": "api.example.com",
    "uri": "/api/v1/users",
    "request_time": 0.123,
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "protocol": "HTTP/1.1",
    "trace_session_id": "",
    "server_protocol": "HTTP/1.1",
    "content_type": "application/json",
    "bytes_sent": "1500"
  },
  "nginx": {
    "x-forward-for": "10.0.0.1",
    "remote_addr": "10.0.0.1",
    "http_referrer": ""
  }
}
```

## Особенности реализации

1. **Случайный выбор из списков**: Все значения (IP, метод, путь, статус код, хост) выбираются случайным образом из предоставленных списков
2. **Реалистичные данные**:
   - Размер отправляемых байт зависит от статус кода:
     - Ошибки 4xx/5xx: 30-120 байт
     - Успешные ответы (1xx, 2xx, 3xx): 800-3100 байт
   - Время запроса генерируется в диапазоне 0.001-2.000 секунд
   - User-Agent генерируется автоматически с помощью библиотеки gofakeit
3. **Автоматическая генерация**:
   - Request ID на основе UUID (в нижнем регистре)
   - User-Agent с помощью gofakeit
   - URL формируется как комбинация хоста и пути (автоматически обрабатываются слеши)
4. **Контроль частоты**: Точный контроль количества логов в секунду через параметр `RATE` (float)
5. **Проверка входных данных**: 
   - Все обязательные списки должны быть не пустыми
   - STATUS_CODES автоматически преобразуется из строк в числа

## Структура лога

Каждая запись лога содержит:
- **ts**: Временная метка (timestamp)
- **http**: HTTP-информация
  - `request_id`: Уникальный идентификатор запроса (UUID)
  - `method`: HTTP-метод (GET, POST, PUT и т.д.)
  - `status_code`: Код статуса HTTP
  - `url`: Полный URL (хост + путь)
  - `host`: Доменное имя хоста
  - `uri`: Путь запроса
  - `request_time`: Время обработки запроса в секундах
  - `user_agent`: User-Agent клиента
  - `protocol`: Версия HTTP протокола
  - `trace_session_id`: Идентификатор сессии трассировки (всегда пустая строка)
  - `server_protocol`: Версия серверного протокола
  - `content_type`: Тип контента (всегда "application/json")
  - `bytes_sent`: Количество отправленных байт
- **nginx**: Информация Nginx
  - `x-forward-for`: IP-адрес клиента из заголовка X-Forwarded-For
  - `remote_addr`: IP-адрес клиента
  - `http_referrer`: Референр (всегда пустая строка)

## Лицензия

Этот инструмент распространяется под лицензией [MIT License](LICENSE).
