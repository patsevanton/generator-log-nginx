# Nginx Log Generator

Этот проект является форком https://github.com/kscarlett/nginx-log-generator с изменённой логикой генерации логов.

Утилита на Go для генерации реалистичных логов Nginx в формате JSON. Она предназначена для тестирования пайплайнов сбора логов, демонстрации работы в Kubernetes и других сценариев, требующих реалистичных данных логов.

Большая часть данных генерируется с помощью библиотеки [gofakeit](https://github.com/brianvoe/gofakeit).

## Основные изменения в форке

В отличие от исходной версии, в этой реализации **все основные параметры логов задаются через обязательные переменные окружения**, что обеспечивает полный контроль над генерируемыми данными:

- **IP_ADDRESSES** - список IP-адресов
- **HTTP_METHODS** - список HTTP-методов
- **PATHS** - список URL-путей
- **STATUS_CODES** - список HTTP-статус кодов

## Сборка из исходного кода

Для сборки бинарного файла из исходного кода:

1. Убедитесь, что у вас установлен Go (версия 1.25 или выше)
2. Выполните сборку:
```shell
go build -o nginx-log-generator .
```

## Использование

### Основные обязательные переменные окружения

```shell
# Минимальный пример запуска
IP_ADDRESSES="10.0.0.1.1,10.0.0.2,10.0.0.3" \
HTTP_METHODS="GET,POST,PUT" \
PATHS="/api/v1/users,/api/v1/products,/api/v1/users,/api/v1/categories" \
STATUS_CODES="200,400,404,500,503" \
HOSTS="api.example.com" \
RATE=5 \
./nginx-log-generator
```

### Запуск через Docker

```shell
docker pull ghcr.io/patsevanton/generator-log-nginx:latest

docker run \
  -e "IP_ADDRESSES=10.0.0.1,10.0.0.2,10.0.0.3" \
  -e "HTTP_METHODS=GET,POST,PUT" \
  -e "PATHS=/api/v1/users,/api/v1/products,/api/v1/users,/api/v1/categories" \
  -e "STATUS_CODES=200,400,404,500,503" \
  -e "HOSTS=api.example.com" \
  -e "RATE=10" \
  ghcr.io/patsevanton/generator-log-nginx:latest
```

### Конфигурация

Все переменные окружения, кроме отмеченных, являются обязательными:

| Название              | Обязательный | По умолчанию | Описание                                                                 |
| --------------------- | ------------ | ------------ | ------------------------------------------------------------------------ |
| **IP_ADDRESSES**      | **Да**       | -            | Список IP-адресов через запятую (например, "192.168.1.1,10.0.0.1")       |
| **HTTP_METHODS**      | **Да**       | -            | Список HTTP-методов через запятую (например, "GET,POST,PUT")             |
| **PATHS**             | **Да**       | -            | Список путей через запятую (например, "/api/v1/users,/api/v1/products")  |
| **STATUS_CODES**      | **Да**       | -            | Список кодов статуса через запятую (например, "200,400,404,500")         |
| **HOSTS**             | **Да**       | -            | Список хостов через запятую (например, "example.com,api.example.com")    |
| RATE                  | Нет          | 1            | Количество логов в секунду (float)                                       |
| PATH_MIN              | Нет          | 1            | Минимальная длина пути (используется при генерации случайного пути)      |
| PATH_MAX              | Нет          | 5            | Максимальная длина пути (используется при генерации случайного пути)     |

**Важно**: 
- Если списки (`IP_ADDRESSES`, `HTTP_METHODS`, `PATHS`, `STATUS_CODES`, `HOSTS`) не заданы, программа завершится с ошибкой
- Значения выбираются случайным образом из предоставленных списков

## Пример выходных данных

Программа выводит логи в формате JSON с префиксом:
```
ingress-nginx-controller controller {"ts":"2023-10-01T12:00:00Z","http":{...},"nginx":{...}}
```

Пример полной записи лога:
```json
{
  "ts": "2023-10-01T12:00:00Z",
  "http": {
    "request_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "method": "GET",
    "status_code": 200,
    "url": "example.com/api/v1/users",
    "host": "example.com",
    "uri": "/api/v1/users",
    "request_time": 0.123,
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "protocol": "HTTP/1.1",
    "trace_session_id": "",
    "server_protocol": "HTTP/1.1",
    "content_type": "application/json",
    "bytes_sent": "1500"
  },
  "nginx": {
    "x-forward-for": "192.168.1.1",
    "remote_addr": "192.168.1.1",
    "http_referrer": ""
  }
}
```

## Особенности реализации

1. **Случайный выбор из списков**: Все значения (IP, метод, путь, статус код, хост) выбираются случайным образом из предоставленных списков
2. **Реалистичные данные**:
   - Размер отправляемых байт зависит от статус кода (ошибки 4xx/5xx: 30-120 байт, успешные: 800-3100 байт)
   - Время запроса генерируется в диапазоне 0.001-2.000 секунд
   - User-Agent генерируется автоматически
3. **Автоматическая генерация**:
   - Request ID на основе UUID
   - User-Agent с помощью gofakeit
   - URL формируется как комбинация хоста и пути
4. **Контроль частоты**: Точный контроль количества логов в секунду через параметр `RATE` (float)
5. **Проверка входных данных**: 
   - Все обязательные списки должны быть не пустыми
   - Корректировка min/max значений для длины пути

## Структура лога

Каждая запись лога содержит:
- **ts**: Временная метка
- **http**: HTTP-информация (метод, статус, URL, хост, user-agent и др.)
- **nginx**: Информация Nginx (IP-адреса, реферер)

## Лицензия

Этот инструмент распространяется под лицензией [MIT License](LICENSE).
